<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Barotrauma Client Doc: CsPackageManager.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Barotrauma Client Doc
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_cs_package_manager_8cs_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">CsPackageManager.cs</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">using</span> System;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="keyword">using</span> System.Collections.Generic;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="keyword">using</span> System.Collections.Immutable;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keyword">using</span> System.Diagnostics.CodeAnalysis;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keyword">using</span> System.IO;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="keyword">using</span> System.Linq;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">using</span> System.Reflection;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">using</span> System.Text;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">using</span> System.Threading;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using</span> <a class="code" href="namespace_barotrauma.html">Barotrauma</a>.<a class="code" href="namespace_barotrauma_1_1_steam.html">Steam</a>;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">using</span> Microsoft.CodeAnalysis;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">using</span> Microsoft.CodeAnalysis.CSharp;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">using</span> MonoMod.Utils;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespace_barotrauma.html">Barotrauma</a>;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; </div>
<div class="line"><a name="l00017"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html">   17</a></span>&#160;<span class="keyword">public</span> sealed <span class="keyword">class </span><a class="code" href="class_cs_package_manager.html">CsPackageManager</a> : IDisposable</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;{</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">    #region PRIVATE_FUNCDATA</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160; </div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> readonly CSharpParseOptions ScriptParseOptions = CSharpParseOptions.Default</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        .WithPreprocessorSymbols(<span class="keyword">new</span>[]</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;        {</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#if SERVER</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;            <span class="stringliteral">&quot;SERVER&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#elif CLIENT</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;            <span class="stringliteral">&quot;CLIENT&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;            <span class="stringliteral">&quot;UNDEFINED&quot;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#if DEBUG</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;            ,<span class="stringliteral">&quot;DEBUG&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        });</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160; </div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#if WINDOWS</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PLATFORM_TARGET = <span class="stringliteral">&quot;Windows&quot;</span>;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#elif OSX</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PLATFORM_TARGET = <span class="stringliteral">&quot;OSX&quot;</span>;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#elif LINUX</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> PLATFORM_TARGET = <span class="stringliteral">&quot;Linux&quot;</span>;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#if CLIENT</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> ARCHITECTURE_TARGET = <span class="stringliteral">&quot;Client&quot;</span>;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#elif SERVER</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> ARCHITECTURE_TARGET = <span class="stringliteral">&quot;Server&quot;</span>;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> readonly CSharpCompilationOptions CompilationOptions = <span class="keyword">new</span> CSharpCompilationOptions(OutputKind.DynamicallyLinkedLibrary)</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        .WithMetadataImportOptions(MetadataImportOptions.All)</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#if DEBUG</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        .WithOptimizationLevel(OptimizationLevel.Debug)</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        .WithOptimizationLevel(OptimizationLevel.Release)</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        .WithAllowUnsafe(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    </div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> readonly SyntaxTree BaseAssemblyImports = CSharpSyntaxTree.ParseText(</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        <span class="keyword">new</span> StringBuilder()</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            .AppendLine(<span class="stringliteral">&quot;using System.Reflection;&quot;</span>)</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;            .AppendLine(<span class="stringliteral">&quot;using Barotrauma;&quot;</span>)</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            .AppendLine(<span class="stringliteral">&quot;using System.Runtime.CompilerServices;&quot;</span>)</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;#<span class="keywordflow">if</span> CLIENT</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            .AppendLine(<span class="stringliteral">&quot;[assembly: IgnoresAccessChecksTo(\&quot;Barotrauma\&quot;)]&quot;</span>)</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;#elif SERVER</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;            .AppendLine(<span class="stringliteral">&quot;[assembly: IgnoresAccessChecksTo(\&quot;DedicatedServer\&quot;)]&quot;</span>)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;#endif</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            .ToString(),</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        ScriptParseOptions);</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> SCRIPT_FILE_REGEX = <span class="stringliteral">&quot;*.cs&quot;</span>;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> ASSEMBLY_FILE_REGEX = <span class="stringliteral">&quot;*.dll&quot;</span>;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keyword">private</span> readonly <span class="keywordtype">float</span> _assemblyUnloadTimeoutSeconds = 4f;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="keyword">private</span> Guid _publicizedAssemblyLoader;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keyword">private</span> readonly List&lt;ContentPackage&gt; _currentPackagesByLoadOrder = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;ContentPackage, ImmutableList&lt;ContentPackage&gt;&gt; _packagesDependencies = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;ContentPackage, Guid&gt; _loadedCompiledPackageAssemblies = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;Guid, ContentPackage&gt; _reverseLookupGuidList = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;Guid, HashSet&lt;IAssemblyPlugin&gt;&gt; _loadedPlugins = <span class="keyword">new</span> ();</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;Guid, ImmutableHashSet&lt;Type&gt;&gt; _pluginTypes = <span class="keyword">new</span>(); <span class="comment">// where Type : IAssemblyPlugin</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;ContentPackage, RunConfig&gt; _packageRunConfigs = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keyword">private</span> readonly Dictionary&lt;Guid, ImmutableList&lt;Type&gt;&gt; _luaRegisteredTypes = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keyword">private</span> readonly <a class="code" href="class_assembly_manager.html">AssemblyManager</a> _assemblyManager;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keyword">private</span> readonly LuaCsSetup _luaCsSetup;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keyword">private</span> DateTime _assemblyUnloadStartTime;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160; </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">    #endregion</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor">    #region PUBLIC_API</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160; </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor">    #region LUA_EXTENSIONS</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160; </div>
<div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#ac738a088519b2cdaa8c4565a0faeb687">  102</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#ac738a088519b2cdaa8c4565a0faeb687">LuaTryRegisterPackageTypes</a>(<span class="keywordtype">string</span> name, <span class="keywordtype">bool</span> caseSensitive = <span class="keyword">false</span>)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a>)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        var matchingPacks = _loadedCompiledPackageAssemblies</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            .Where(kvp =&gt; kvp.Key.Name.ToLowerInvariant().Contains(name.ToLowerInvariant()))</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            .Select(kvp =&gt; kvp.Value)</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            .ToImmutableList();</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">if</span> (!matchingPacks.Any())</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        var types = matchingPacks</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;            .Where(guid =&gt; !_luaRegisteredTypes.ContainsKey(guid))</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            .Select(guid =&gt; <span class="keyword">new</span> KeyValuePair&lt;Guid, ImmutableList&lt;Type&gt;&gt;(</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                guid, </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                _assemblyManager.TryGetSubTypesFromACL(guid, out var types) </div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                    ? types.ToImmutableList()</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                    : ImmutableList&lt;Type&gt;.Empty))</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            .ToImmutableList();</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordflow">if</span> (!types.Any())</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">foreach</span> (var kvp <span class="keywordflow">in</span> types)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        {</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            _luaRegisteredTypes[kvp.Key] = kvp.Value;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;            <span class="keywordflow">foreach</span> (Type type <span class="keywordflow">in</span> kvp.Value)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            {</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;                MoonSharp.Interpreter.UserData.RegisterType(type);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            }</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        }</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    }</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160; </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="preprocessor">    #endregion</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    </div>
<div class="line"><a name="l00139"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">  139</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a> { <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; }</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    </div>
<div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#ac68001aa5c72f709a3ff25ff85aa5f11">  145</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#ac68001aa5c72f709a3ff25ff85aa5f11">PluginsPreInit</a> { <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; }</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    </div>
<div class="line"><a name="l00150"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">  150</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">PluginsInitialized</a> { <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; } = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#ada5efea29c52e47b7de7ad220d9ca442">  155</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#ada5efea29c52e47b7de7ad220d9ca442">PluginsLoaded</a> { <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; } = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#aec7c12a90515e14382a0dd65f5788761">  157</a></span>&#160;    <span class="keyword">public</span> IEnumerable&lt;ContentPackage&gt; <a class="code" href="class_cs_package_manager.html#aec7c12a90515e14382a0dd65f5788761">GetCurrentPackagesByLoadOrder</a>() =&gt; _currentPackagesByLoadOrder;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#aa696ddd3e1dd29288241085f01a62acc">  165</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#aa696ddd3e1dd29288241085f01a62acc">TryGetPackageForPlugin&lt;T&gt;</a>(out ContentPackage package) where T : <a class="code" href="interface_i_assembly_plugin.html">IAssemblyPlugin</a></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="keyword">package </span>= null;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        var t = typeof(T);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        var guid = _pluginTypes</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;            .Where(kvp =&gt; kvp.Value.Contains(t))</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            .Select(kvp =&gt; kvp.Key)</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            .FirstOrDefault(Guid.Empty);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordflow">if</span> (guid.Equals(Guid.Empty) || !_reverseLookupGuidList.ContainsKey(guid) || _reverseLookupGuidList[guid] is <span class="keyword">null</span>)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keyword">package </span>= _reverseLookupGuidList[guid];</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    }</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a20c78091fe9d8c5ec0c6391f14376637">  188</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#a20c78091fe9d8c5ec0c6391f14376637">TryGetLoadedPluginsForPackage</a>(ContentPackage package, out IEnumerable&lt;IAssemblyPlugin&gt; loadedPlugins)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        loadedPlugins = <span class="keyword">null</span>;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="keywordflow">if</span> (package is <span class="keyword">null</span> || !_loadedCompiledPackageAssemblies.ContainsKey(package))</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        var guid = _loadedCompiledPackageAssemblies[package];</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">if</span> (guid.Equals(Guid.Empty) || !_loadedPlugins.ContainsKey(guid))</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;        loadedPlugins = _loadedPlugins[guid];</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00203"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">  203</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">event</span> Action <a class="code" href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">OnDispose</a>; </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160; </div>
<div class="line"><a name="l00205"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a44c3b8295b793470cb43f41bfac81689">  205</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_cs_package_manager.html#a44c3b8295b793470cb43f41bfac81689">Dispose</a>()</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="comment">// send events for cleanup</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <a class="code" href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">OnDispose</a>?.Invoke();</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="comment">// cleanup events</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">OnDispose</a> is not <span class="keyword">null</span>)</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        {</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;            <span class="keywordflow">foreach</span> (Delegate del <span class="keywordflow">in</span> <a class="code" href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">OnDispose</a>.GetInvocationList())</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;            {</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                <a class="code" href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">OnDispose</a> -= (del as System.Action);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;            }</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        }</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="comment">// cleanup plugins and assemblies</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        ReflectionUtils.ResetCache();</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <a class="code" href="class_cs_package_manager.html#a97ebeeb2b13eb0c63ec0d57a818d03e2">UnloadPlugins</a>();</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="comment">// try cleaning up the assemblies</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        _pluginTypes.Clear();   <span class="comment">// remove assembly references</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        _loadedPlugins.Clear();</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="comment">// lua cleanup</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="keywordflow">foreach</span> (var kvp <span class="keywordflow">in</span> _luaRegisteredTypes)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;            <span class="keywordflow">foreach</span> (Type type <span class="keywordflow">in</span> kvp.Value)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            {</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                MoonSharp.Interpreter.UserData.UnregisterType(type);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;            }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        }</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        _luaRegisteredTypes.Clear();</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        _assemblyUnloadStartTime = DateTime.Now;</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        _publicizedAssemblyLoader = Guid.Empty;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        </div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="comment">// we can&#39;t wait forever or app dies but we can try to be graceful</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="keywordflow">while</span> (!_assemblyManager.TryBeginDispose())</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            <span class="keywordflow">if</span> (_assemblyUnloadStartTime.AddSeconds(_assemblyUnloadTimeoutSeconds) &gt; DateTime.Now)</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            {</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;            }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        </div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        _assemblyUnloadStartTime = DateTime.Now;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="keywordflow">while</span> (!_assemblyManager.FinalizeDispose())</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        {</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            <span class="keywordflow">if</span> (_assemblyUnloadStartTime.AddSeconds(_assemblyUnloadTimeoutSeconds) &gt; DateTime.Now)</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            {</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;            }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        }</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        _assemblyManager.OnAssemblyLoaded -= AssemblyManagerOnAssemblyLoaded;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        _assemblyManager.OnAssemblyUnloading -= AssemblyManagerOnAssemblyUnloading;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160; </div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        _publicizedAssemblyLoader = Guid.Empty;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;            </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="comment">// clear lists after cleaning up</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        _packagesDependencies.Clear();</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        _loadedCompiledPackageAssemblies.Clear();</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        _reverseLookupGuidList.Clear();</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        _packageRunConfigs.Clear();</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        _currentPackagesByLoadOrder.Clear();</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; </div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        GC.SuppressFinalize(<span class="keyword">this</span>);  </div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    }</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#aa0761c436738450d43a3e529f68f4f9f">  277</a></span>&#160;    <span class="keyword">public</span> AssemblyLoadingSuccessState <a class="code" href="class_cs_package_manager.html#aa0761c436738450d43a3e529f68f4f9f">LoadAssemblyPackages</a>()</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    {</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a>)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        {</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;            <span class="keywordflow">return</span> AssemblyLoadingSuccessState.AlreadyLoaded;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        }</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        _assemblyManager.OnAssemblyLoaded += AssemblyManagerOnAssemblyLoaded;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        _assemblyManager.OnAssemblyUnloading += AssemblyManagerOnAssemblyUnloading;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160; </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="comment">// log error if some ACLs are still unloading (some assembly is still in use)</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">if</span> (_assemblyManager.IsCurrentlyUnloading)</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        {</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;WARNING: Some mods from a previous session (lobby) are still loaded! This may result in undefined behaviour! Please restart your game. \nIf you wish to avoid this issue in the future, please disable the below mods and report the error to the mod author.&quot;</span>);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            <span class="keywordflow">foreach</span> (var wkref <span class="keywordflow">in</span> _assemblyManager.StillUnloadingACLs)</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;            {</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                ModUtils.Logging.PrintError($<span class="stringliteral">&quot;The below ACL is still unloading:&quot;</span>);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                <span class="keywordflow">if</span> (wkref.TryGetTarget(out var tgt))</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                {</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;ACL Name: {tgt.Name}&quot;</span>);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                    <span class="keywordflow">foreach</span> (Assembly assembly <span class="keywordflow">in</span> tgt.Assemblies)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                    {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                        ModUtils.Logging.PrintError($<span class="stringliteral">&quot;-- Assembly: {assembly.GetName()}&quot;</span>);</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                    }</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                }</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            }</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        }</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        </div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <span class="comment">// load publicized assemblies</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        var publicizedDir = Path.Combine(Environment.CurrentDirectory, <span class="stringliteral">&quot;Publicized&quot;</span>);</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        </div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="comment">// if using workshop lua setup is checked, try to use the publicized assemblies in the content package there instead.</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keywordflow">if</span> (_luaCsSetup.Config.PreferToUseWorkshopLuaSetup)</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        {</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;            var pck = LuaCsSetup.GetPackage(LuaCsSetup.LuaForBarotraumaId);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;            <span class="keywordflow">if</span> (pck is not <span class="keyword">null</span>)</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;            {</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                publicizedDir = Path.Combine(pck.Dir, <span class="stringliteral">&quot;Binary&quot;</span>, <span class="stringliteral">&quot;Publicized&quot;</span>);</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            }</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        ImmutableList&lt;Assembly&gt; publicizedAssemblies = ImmutableList&lt;Assembly&gt;.Empty;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        ImmutableList&lt;string&gt; list;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        </div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="keywordflow">try</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        {</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            <span class="comment">// search for assemblies</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            list = Directory.GetFiles(publicizedDir, <span class="stringliteral">&quot;*.dll&quot;</span>)</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="preprocessor">#if CLIENT</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                .Where(s =&gt; !s.ToLowerInvariant().EndsWith(<span class="stringliteral">&quot;dedicatedserver.dll&quot;</span>))</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="preprocessor">#elif SERVER</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                .Where(s =&gt; !s.ToLowerInvariant().EndsWith(<span class="stringliteral">&quot;barotrauma.dll&quot;</span>))</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                .ToImmutableList();</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;            <span class="keywordflow">if</span> (list.Count &lt; 1)</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                <span class="keywordflow">throw</span> <span class="keyword">new</span> DirectoryNotFoundException(<span class="stringliteral">&quot;No publicized assemblies found.&quot;</span>);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        }</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <span class="comment">// no directory found, use the other one</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="keywordflow">catch</span> (DirectoryNotFoundException dne)</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;            <span class="keywordflow">if</span> (_luaCsSetup.Config.PreferToUseWorkshopLuaSetup)</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            {</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                ModUtils.Logging.PrintError($<span class="stringliteral">&quot;Unable to find &lt;LuaCsPackage&gt;/Binary/Publicized/ . Using Game folder instead.&quot;</span>);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                publicizedDir = Path.Combine(Environment.CurrentDirectory, <span class="stringliteral">&quot;Publicized&quot;</span>);</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;            }</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                ModUtils.Logging.PrintError($<span class="stringliteral">&quot;Unable to find &lt;GameFolder&gt;/Publicized/ . Using LuaCsPackage folder instead.&quot;</span>);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                var pck = LuaCsSetup.GetPackage(LuaCsSetup.LuaForBarotraumaId);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                <span class="keywordflow">if</span> (pck is not <span class="keyword">null</span>)</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                {</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                    publicizedDir = Path.Combine(pck.Dir, <span class="stringliteral">&quot;Binary&quot;</span>, <span class="stringliteral">&quot;Publicized&quot;</span>);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                }</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;            </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;            <span class="comment">// search for assemblies</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            list = Directory.GetFiles(publicizedDir, <span class="stringliteral">&quot;*.dll&quot;</span>)</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="preprocessor">#if CLIENT</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                .Where(s =&gt; !s.ToLowerInvariant().EndsWith(<span class="stringliteral">&quot;dedicatedserver.dll&quot;</span>))</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor">#elif SERVER</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                .Where(s =&gt; !s.ToLowerInvariant().EndsWith(<span class="stringliteral">&quot;barotrauma.dll&quot;</span>))</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                .ToImmutableList();</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        }</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160; </div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="comment">// try load them into an acl</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        var loadState = _assemblyManager.LoadAssembliesFromLocations(list, <span class="stringliteral">&quot;luacs_publicized_assemblies&quot;</span>, ref _publicizedAssemblyLoader);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <span class="comment">// loaded</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        <span class="keywordflow">if</span> (loadState is AssemblyLoadingSuccessState.Success)</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="keywordflow">if</span> (_assemblyManager.TryGetACL(_publicizedAssemblyLoader, out var acl))</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            {</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                publicizedAssemblies = acl.Acl.Assemblies.ToImmutableList();</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                _assemblyManager.SetACLToTemplateMode(_publicizedAssemblyLoader);</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            }</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="comment">// get packages</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        IEnumerable&lt;ContentPackage&gt; packages = BuildPackagesList();</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        </div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        <span class="comment">// check and load config</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        _packageRunConfigs.AddRange(packages</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            .Select(p =&gt; <span class="keyword">new</span> KeyValuePair&lt;ContentPackage, RunConfig&gt;(p, GetRunConfigForPackage(p)))</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            .ToDictionary(p =&gt; p.Key, p=&gt; p.Value));</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        </div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        <span class="comment">// filter not to be loaded</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        var cpToRunA = _packageRunConfigs</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            .Where(kvp =&gt; ShouldRunPackage(kvp.Key, kvp.Value))</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            .Select(kvp =&gt; kvp.Key)</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            .ToHashSet();</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        </div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="comment">//-- filter and remove duplicate mods, prioritize /LocalMods/</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        HashSet&lt;string&gt; cpNames = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        HashSet&lt;string&gt; duplicateNames = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160; </div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="comment">// search</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="keywordflow">foreach</span> (ContentPackage package <span class="keywordflow">in</span> cpToRunA)</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            <span class="keywordflow">if</span> (cpNames.Contains(package.Name))</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            {</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                <span class="keywordflow">if</span> (!duplicateNames.Contains(package.Name))</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                {</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                    duplicateNames.Add(package.Name);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                }</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;            {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                cpNames.Add(package.Name);</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            }        </div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        }</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160; </div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        <span class="comment">// remove</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> name <span class="keywordflow">in</span> duplicateNames)</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        {</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;            var duplCpList = cpToRunA</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                .Where(p =&gt; p.Name.Equals(name))</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                .ToHashSet();</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;            </div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            <span class="keywordflow">if</span> (duplCpList.Count &lt; 2)   <span class="comment">// one or less found</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            ContentPackage toKeep = <span class="keyword">null</span>;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            <span class="keywordflow">foreach</span> (ContentPackage package <span class="keywordflow">in</span> duplCpList)</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            {</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                <span class="keywordflow">if</span> (package.Dir.Contains(<span class="stringliteral">&quot;LocalMods&quot;</span>))</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                {</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                    toKeep = package;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                }</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            }</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160; </div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            toKeep ??= duplCpList.First();</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160; </div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;            duplCpList.Remove(toKeep);  <span class="comment">// remove all but this one</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            cpToRunA.RemoveWhere(p =&gt; duplCpList.Contains(p));</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160; </div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        var cpToRun = cpToRunA.ToImmutableList();</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        <span class="comment">// build dependencies map</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        <span class="keywordtype">bool</span> reliableMap = TryBuildDependenciesMap(cpToRun, out var packDeps);</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="keywordflow">if</span> (!reliableMap)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;            ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to create reliable dependencies map.&quot;</span>);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        _packagesDependencies.AddRange(packDeps.ToDictionary(</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;            kvp =&gt; kvp.Key, </div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            kvp =&gt; kvp.Value.ToImmutableList())</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        );</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160; </div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        List&lt;ContentPackage&gt; packagesToLoadInOrder = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="comment">// build load order</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <span class="keywordflow">if</span> (reliableMap &amp;&amp; OrderAndFilterPackagesByDependencies(</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                _packagesDependencies,</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                out var readyToLoad,</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                out var cannotLoadPackages,</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                <span class="keyword">null</span>))</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        {</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            packagesToLoadInOrder.AddRange(readyToLoad);</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            <span class="keywordflow">if</span> (cannotLoadPackages is not <span class="keyword">null</span>)</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;            {</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to load the following mods due to dependency errors:&quot;</span>);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                <span class="keywordflow">foreach</span> (var pair <span class="keywordflow">in</span> cannotLoadPackages)</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;Package: {pair.Key.Name} | Reason: {pair.Value}&quot;</span>);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                }</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;            }</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;        }</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        {</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;            <span class="comment">// use unsorted list on failure and send error message.</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;            packagesToLoadInOrder.AddRange(_packagesDependencies.Select( p=&gt; p.Key));</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to create a reliable load order. Defaulting to unordered loading!&quot;</span>);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        }</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        </div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="comment">// get assemblies and scripts&#39; filepaths from packages</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        var toLoad = packagesToLoadInOrder</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;            .Select(cp =&gt; <span class="keyword">new</span> KeyValuePair&lt;ContentPackage, LoadableData&gt;(</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                cp,</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                <span class="keyword">new</span> LoadableData(</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                    TryScanPackagesForAssemblies(cp, out var list1) ? list1 : <span class="keyword">null</span>,</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                    TryScanPackageForScripts(cp, out var list2) ? list2 : <span class="keyword">null</span>)))</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            .ToImmutableDictionary();</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        </div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        HashSet&lt;ContentPackage&gt; badPackages = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        <span class="keywordflow">foreach</span> (var pair <span class="keywordflow">in</span> toLoad)</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        {</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;            <span class="comment">// check if unloadable</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;            <span class="keywordflow">if</span> (badPackages.Contains(pair.Key))</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160; </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;            <span class="comment">// try load binary assemblies</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            var <span class="keywordtype">id</span> = Guid.Empty;    <span class="comment">// id for the ACL for this package defined by AssemblyManager.</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;            AssemblyLoadingSuccessState successState;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;            <span class="keywordflow">if</span> (pair.Value.AssembliesFilePaths is not <span class="keyword">null</span> &amp;&amp; pair.Value.AssembliesFilePaths.Any())</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            {</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;Loading assemblies for CPackage {pair.Key.Name}&quot;</span>);</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="preprocessor">#if DEBUG</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> assembliesFilePath <span class="keywordflow">in</span> pair.Value.AssembliesFilePaths)</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                {</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;                    ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;Found assemblies located at {Path.GetFullPath(ModUtils.IO.SanitizePath(assembliesFilePath))}&quot;</span>);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;                }</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                </div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;                successState = _assemblyManager.LoadAssembliesFromLocations(pair.Value.AssembliesFilePaths, pair.Key.Name, ref <span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160; </div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                <span class="comment">// error handling</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                <span class="keywordflow">if</span> (successState is not AssemblyLoadingSuccessState.Success)</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;                {</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to load the binary assemblies for package {pair.Key.Name}. Error: {successState.ToString()}&quot;</span>);</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                    UpdatePackagesToDisable(ref badPackages, pair.Key, _packagesDependencies);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;            }</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;            </div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;            <span class="comment">// try compile scripts to assemblies</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;            <span class="keywordflow">if</span> (pair.Value.ScriptsFilePaths is not <span class="keyword">null</span> &amp;&amp; pair.Value.ScriptsFilePaths.Any())</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            {</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;Loading scripts for CPackage {pair.Key.Name}&quot;</span>);</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                List&lt;SyntaxTree&gt; syntaxTrees = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;            </div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;                syntaxTrees.Add(GetPackageScriptImports());</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                <span class="keywordtype">bool</span> abortPackage = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;                <span class="comment">// load scripts data from files</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> scriptPath <span class="keywordflow">in</span> pair.Value.ScriptsFilePaths)</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                    var state = ModUtils.IO.GetOrCreateFileText(scriptPath, out <span class="keywordtype">string</span> fileText, <span class="keyword">null</span>, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                    <span class="comment">// could not load file data</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                    <span class="keywordflow">if</span> (state is not ModUtils.IO.IOActionResultState.Success)</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                    {</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                        ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to load the script files for package {pair.Key.Name}. Error: {state.ToString()}&quot;</span>);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                        UpdatePackagesToDisable(ref badPackages, pair.Key, _packagesDependencies);</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                        abortPackage = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                    }</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;                    <span class="keywordflow">try</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;                    {</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                        CancellationToken token = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;                        syntaxTrees.Add(SyntaxFactory.ParseSyntaxTree(fileText, ScriptParseOptions, scriptPath, Encoding.Default, token));</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                        <span class="comment">// cancel if parsing failed</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                        <span class="keywordflow">if</span> (token.IsCancellationRequested)</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                        {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to load the script files for package {pair.Key.Name}. Error: Syntax Parse Error.&quot;</span>);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                            UpdatePackagesToDisable(ref badPackages, pair.Key, _packagesDependencies);</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;                            abortPackage = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;                            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                        }</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                    }</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                    <span class="keywordflow">catch</span> (Exception e)</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                    {</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                        <span class="comment">// unknown error</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                        ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to load the script files for package {pair.Key.Name}. Error: {e.Message}&quot;</span>);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                        UpdatePackagesToDisable(ref badPackages, pair.Key, _packagesDependencies);</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                        abortPackage = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                    }</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                </div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                }</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                </div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                <span class="keywordflow">if</span> (abortPackage)</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                <span class="comment">// try compile</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                successState = _assemblyManager.LoadAssemblyFromMemory(</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                    pair.Key.Name.Replace(<span class="stringliteral">&quot; &quot;</span>,<span class="stringliteral">&quot;&quot;</span>), </div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                    syntaxTrees, </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;                    <span class="keyword">null</span>, </div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                    CompilationOptions, </div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                     pair.Key.Name, ref <span class="keywordtype">id</span>, publicizedAssemblies);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                <span class="keywordflow">if</span> (successState is not AssemblyLoadingSuccessState.Success)</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                {</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Unable to compile script assembly for package {pair.Key.Name}. Error: {successState.ToString()}&quot;</span>);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                    UpdatePackagesToDisable(ref badPackages, pair.Key, _packagesDependencies);</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            }</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160; </div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            <span class="comment">// something was loaded, add to index</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            <span class="keywordflow">if</span> (<span class="keywordtype">id</span> != Guid.Empty)</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            {</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;Assemblies from CPackage {pair.Key.Name} loaded with Guid {id}.&quot;</span>);</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                _loadedCompiledPackageAssemblies.Add(pair.Key, <span class="keywordtype">id</span>);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                _reverseLookupGuidList.Add(<span class="keywordtype">id</span>, pair.Key);</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            }</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        }</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160; </div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        <span class="comment">// update loaded packages to exclude bad packages</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        _currentPackagesByLoadOrder.AddRange(toLoad</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            .Where(p =&gt; !badPackages.Contains(p.Key))</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;            .Select(p =&gt; p.Key));</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160; </div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="comment">// build list of plugins</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="keywordflow">foreach</span> (var pair <span class="keywordflow">in</span> _loadedCompiledPackageAssemblies)</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        {</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            <span class="keywordflow">if</span> (_assemblyManager.TryGetSubTypesFromACL&lt;<a class="code" href="interface_i_assembly_plugin.html">IAssemblyPlugin</a>&gt;(pair.Value, out var types))</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;            {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                _pluginTypes[pair.Value] = types.ToImmutableHashSet();</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                <span class="keywordflow">foreach</span> (var type <span class="keywordflow">in</span> _pluginTypes[pair.Value])</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                {</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                    ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;Loading type: {type.Name}&quot;</span>);</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                }</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;            }</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160; </div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        this.<a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <span class="keywordflow">return</span> AssemblyLoadingSuccessState.Success;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        </div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160; </div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        <span class="keywordtype">bool</span> ShouldRunPackage(ContentPackage package, <a class="code" href="class_run_config.html">RunConfig</a> config)</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        {</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;            <span class="keywordflow">if</span> (config.<a class="code" href="class_run_config.html#a416484085c3efd4cb3741c1ae6cd9ffa">AutoGenerated</a>)</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            <span class="keywordflow">return</span> (!_luaCsSetup.Config.TreatForcedModsAsNormal &amp;&amp; config.<a class="code" href="class_run_config.html#ab4e1322504d43e9a13af4a86208626cc">IsForced</a>())</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                   || (ContentPackageManager.EnabledPackages.All.Contains(package) &amp;&amp; config.<a class="code" href="class_run_config.html#ac17a7cd03af7ba9ab0d510464ffd154f">IsForcedOrStandard</a>());</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        }</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160; </div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="keywordtype">void</span> UpdatePackagesToDisable(ref HashSet&lt;ContentPackage&gt; list, </div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            ContentPackage newDisabledPackage, </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            IEnumerable&lt;KeyValuePair&lt;ContentPackage, ImmutableList&lt;ContentPackage&gt;&gt;&gt; dependenciesMap)</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        {</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            list.Add(newDisabledPackage);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            <span class="keywordflow">foreach</span> (var package <span class="keywordflow">in</span> dependenciesMap)</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            {</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                <span class="keywordflow">if</span> (package.Value.Contains(newDisabledPackage))</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                    list.Add(newDisabledPackage);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;            }</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        }</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    }</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    </div>
<div class="line"><a name="l00636"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a0bb7fd36c673c19ad7205887af7018fd">  636</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_cs_package_manager.html#a0bb7fd36c673c19ad7205887af7018fd">RunPluginsInit</a>()</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a>)</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        {</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Attempted to call plugins&#39; Initialize() without any loaded assemblies!&quot;</span>);</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        }</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        </div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">PluginsInitialized</a>)</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        {</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Attempted to call plugins&#39; Initialize() without type instantiation!&quot;</span>);</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        }</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;     </div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_cs_package_manager.html#ada5efea29c52e47b7de7ad220d9ca442">PluginsLoaded</a>)</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;        </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <span class="keywordflow">foreach</span> (var contentPlugins <span class="keywordflow">in</span> _loadedPlugins)</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            <span class="comment">// init</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            <span class="keywordflow">foreach</span> (var plugin <span class="keywordflow">in</span> contentPlugins.Value)</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            {</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                TryRun(() =&gt; plugin.Initialize(), $<span class="stringliteral">&quot;{nameof(IAssemblyPlugin.Initialize)}&quot;</span>, plugin.GetType().Name);</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            }</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        }</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        </div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="keywordflow">foreach</span> (var contentPlugins <span class="keywordflow">in</span> _loadedPlugins)</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        {</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="comment">// load complete</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            <span class="keywordflow">foreach</span> (var plugin <span class="keywordflow">in</span> contentPlugins.Value)</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;            {</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                TryRun(() =&gt; plugin.OnLoadCompleted(), $<span class="stringliteral">&quot;{nameof(IAssemblyPlugin.OnLoadCompleted)}&quot;</span>, plugin.GetType().Name);</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;            }</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        }</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160; </div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <a class="code" href="class_cs_package_manager.html#ada5efea29c52e47b7de7ad220d9ca442">PluginsLoaded</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    }</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160; </div>
<div class="line"><a name="l00677"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a1f77c8157a1f2c2d7c3f22cca629743b">  677</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_cs_package_manager.html#a1f77c8157a1f2c2d7c3f22cca629743b">RunPluginsPreInit</a>()</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    {</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a>)</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        {</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Attempted to call plugins&#39; PreInitPatching() without any loaded assemblies!&quot;</span>);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        }</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160; </div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">PluginsInitialized</a>)</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        {</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Attempted to call plugins&#39; PreInitPatching() without type initialization!&quot;</span>);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        }</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        </div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_cs_package_manager.html#ac68001aa5c72f709a3ff25ff85aa5f11">PluginsPreInit</a>)</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        {</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        }</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        </div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="keywordflow">foreach</span> (var contentPlugins <span class="keywordflow">in</span> _loadedPlugins)</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        {</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            <span class="comment">// init</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            <span class="keywordflow">foreach</span> (var plugin <span class="keywordflow">in</span> contentPlugins.Value)</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            {</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                TryRun(() =&gt; plugin.PreInitPatching(), $<span class="stringliteral">&quot;{nameof(IAssemblyPlugin.PreInitPatching)}&quot;</span>, plugin.GetType().Name);</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;            }</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        }</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160; </div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <a class="code" href="class_cs_package_manager.html#ac68001aa5c72f709a3ff25ff85aa5f11">PluginsPreInit</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    }</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160; </div>
<div class="line"><a name="l00712"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a99f48798f41081db900d2433158a003d">  712</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_cs_package_manager.html#a99f48798f41081db900d2433158a003d">InstantiatePlugins</a>(<span class="keywordtype">bool</span> force = <span class="keyword">false</span>)</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    {</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">AssembliesLoaded</a>)</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        {</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Attempted to instantiate plugins without any loaded assemblies!&quot;</span>);</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        }</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        </div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">PluginsInitialized</a>)</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        {</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;            <span class="keywordflow">if</span> (force)</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                <a class="code" href="class_cs_package_manager.html#a97ebeeb2b13eb0c63ec0d57a818d03e2">UnloadPlugins</a>();</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;            {</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Attempted to load plugins when they were already loaded!&quot;</span>);</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            }</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        }</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160; </div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">foreach</span> (var pair <span class="keywordflow">in</span> _pluginTypes)</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        {</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;            <span class="comment">// instantiate</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            <span class="keywordflow">foreach</span> (Type type <span class="keywordflow">in</span> pair.Value)</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            {</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                <span class="keywordflow">if</span> (!_loadedPlugins.ContainsKey(pair.Key))</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                    _loadedPlugins.Add(pair.Key, <span class="keyword">new</span>());</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_loadedPlugins[pair.Key] is <span class="keyword">null</span>)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                    _loadedPlugins[pair.Key] = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                <a class="code" href="interface_i_assembly_plugin.html">IAssemblyPlugin</a> plugin = <span class="keyword">null</span>;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                <span class="keywordflow">try</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                   plugin = (<a class="code" href="interface_i_assembly_plugin.html">IAssemblyPlugin</a>)Activator.CreateInstance(type);</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                }</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                <span class="keywordflow">catch</span> (Exception e)</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                {</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Error while instantiating plugin of type {type}. Now disposing...&quot;</span>);</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="preprocessor">#if DEBUG</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Details: {e.Message} | {e.InnerException}&quot;</span>);</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                    TryRun(() =&gt; plugin?.<a class="code" href="class_cs_package_manager.html#a44c3b8295b793470cb43f41bfac81689">Dispose</a>(), <span class="stringliteral">&quot;Dispose&quot;</span>, type.FullName ?? type.Name);</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160; </div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                    plugin = <span class="keyword">null</span>;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                }</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                <span class="keywordflow">if</span> (plugin is not <span class="keyword">null</span>)</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                    _loadedPlugins[pair.Key].Add(plugin);</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                    ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Error while instantiating plugin of type {type}&quot;</span>);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;            }</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <a class="code" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">PluginsInitialized</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    }</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#a97ebeeb2b13eb0c63ec0d57a818d03e2">  769</a></span>&#160;    <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_cs_package_manager.html#a97ebeeb2b13eb0c63ec0d57a818d03e2">UnloadPlugins</a>()</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    {</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        <span class="keywordflow">foreach</span> (var contentPlugins <span class="keywordflow">in</span> _loadedPlugins)</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        {</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;            <span class="keywordflow">foreach</span> (var plugin <span class="keywordflow">in</span> contentPlugins.Value)</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            {</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                TryRun(() =&gt; plugin.Dispose(), $<span class="stringliteral">&quot;{nameof(IAssemblyPlugin.Dispose)}&quot;</span>, plugin.GetType().Name);</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            }</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            contentPlugins.Value.Clear();</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        }</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        </div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        _loadedPlugins.Clear();</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160; </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        <a class="code" href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">PluginsInitialized</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        <a class="code" href="class_cs_package_manager.html#ac68001aa5c72f709a3ff25ff85aa5f11">PluginsPreInit</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        <a class="code" href="class_cs_package_manager.html#ada5efea29c52e47b7de7ad220d9ca442">PluginsLoaded</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    }</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    </div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    </div>
<div class="line"><a name="l00795"></a><span class="lineno"><a class="line" href="class_cs_package_manager.html#aa915a7fe9a2418104e56d2087302f899">  795</a></span>&#160;    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="class_cs_package_manager.html#aa915a7fe9a2418104e56d2087302f899">GetOrCreateRunConfig</a>(ContentPackage package, out <a class="code" href="class_run_config.html">RunConfig</a> config)</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    {</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        var path = System.IO.Path.Combine(Path.GetFullPath(package.Dir), <span class="stringliteral">&quot;CSharp&quot;</span>, <span class="stringliteral">&quot;RunConfig.xml&quot;</span>);</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        <span class="keywordflow">if</span> (!File.Exists(path))</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;            config = <span class="keyword">new</span> <a class="code" href="class_run_config.html">RunConfig</a>(<span class="keyword">true</span>).<a class="code" href="class_run_config.html#a7d843dcb3c7191dfdfb4f6ba63bc8ccb">Sanitize</a>();</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <span class="keywordflow">return</span> ModUtils.IO.LoadOrCreateTypeXml(out config, path, () =&gt; <span class="keyword">new</span> <a class="code" href="class_run_config.html">RunConfig</a>(<span class="keyword">true</span>).Sanitize(), <span class="keyword">false</span>);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    }</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    </div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="preprocessor">    #endregion</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160; </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="preprocessor">    #region INTERNALS</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160; </div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> TryRun(Action action, <span class="keywordtype">string</span> messageMethodName, <span class="keywordtype">string</span> messageTypeName)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    {</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="keywordflow">try</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        {</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            action?.Invoke();</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;        }</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        <span class="keywordflow">catch</span> (Exception e)</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        {</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Error while running {messageMethodName}() on plugin of type {messageTypeName}&quot;</span>);</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="preprocessor">#if DEBUG</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;{nameof(CsPackageManager)}: Details: {e.Message} | {e.InnerException}&quot;</span>);</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        }</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    }</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    </div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> AssemblyManagerOnAssemblyUnloading(Assembly assembly)</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    {</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        ReflectionUtils.RemoveAssemblyFromCache(assembly);</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    }</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160; </div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keyword">private</span> <span class="keywordtype">void</span> AssemblyManagerOnAssemblyLoaded(Assembly assembly)</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    {</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        <span class="comment">//ReflectionUtils.AddNonAbstractAssemblyTypes(assembly);</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        <span class="comment">// As ReflectionUtils.GetDerivedNonAbstract is only used for Prefabs &amp; Barotrauma-specific implementing types,</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <span class="comment">// we can safely not register System/Core assemblies.</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        <span class="keywordflow">if</span> (assembly.FullName is not <span class="keyword">null</span> &amp;&amp; assembly.FullName.StartsWith(<span class="stringliteral">&quot;System.&quot;</span>))</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        ReflectionUtils.AddNonAbstractAssemblyTypes(assembly, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    }</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    </div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keyword">internal</span> <a class="code" href="class_cs_package_manager.html">CsPackageManager</a>([NotNull] <a class="code" href="class_assembly_manager.html">AssemblyManager</a> assemblyManager, [NotNull] LuaCsSetup luaCsSetup)</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    {</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        this._assemblyManager = assemblyManager;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        this._luaCsSetup = luaCsSetup;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    }</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160; </div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    ~<a class="code" href="class_cs_package_manager.html">CsPackageManager</a>()</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    {</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        this.<a class="code" href="class_cs_package_manager.html#a44c3b8295b793470cb43f41bfac81689">Dispose</a>();</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    }</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> TryScanPackageForScripts(ContentPackage package, out ImmutableList&lt;string&gt; scriptFilePaths)</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    {</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        <span class="keywordtype">string</span> pathShared = Path.Combine(ModUtils.IO.GetContentPackageDir(package), <span class="stringliteral">&quot;CSharp&quot;</span>, <span class="stringliteral">&quot;Shared&quot;</span>);</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        <span class="keywordtype">string</span> pathArch = Path.Combine(ModUtils.IO.GetContentPackageDir(package), <span class="stringliteral">&quot;CSharp&quot;</span>, ARCHITECTURE_TARGET);</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160; </div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        List&lt;string&gt; files = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160; </div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        <span class="keywordflow">if</span> (Directory.Exists(pathShared))</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;            files.AddRange(Directory.GetFiles(pathShared, SCRIPT_FILE_REGEX, SearchOption.AllDirectories));</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        <span class="keywordflow">if</span> (Directory.Exists(pathArch))</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;            files.AddRange(Directory.GetFiles(pathArch, SCRIPT_FILE_REGEX, SearchOption.AllDirectories));</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160; </div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <span class="keywordflow">if</span> (files.Count &gt; 0)</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        {</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;            scriptFilePaths = files.ToImmutableList();</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;        }</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        scriptFilePaths = ImmutableList&lt;string&gt;.Empty;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    }</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> TryScanPackagesForAssemblies(ContentPackage package, out ImmutableList&lt;string&gt; assemblyFilePaths)</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    {</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        <span class="keywordtype">string</span> path = Path.Combine(ModUtils.IO.GetContentPackageDir(package), <span class="stringliteral">&quot;bin&quot;</span>, ARCHITECTURE_TARGET, PLATFORM_TARGET);</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160; </div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        <span class="keywordflow">if</span> (!Directory.Exists(path))</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        {</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;            assemblyFilePaths = ImmutableList&lt;string&gt;.Empty;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        }</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160; </div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        assemblyFilePaths = System.IO.Directory.GetFiles(path, ASSEMBLY_FILE_REGEX, SearchOption.AllDirectories)</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;            .ToImmutableList();</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        <span class="keywordflow">return</span> assemblyFilePaths.Count &gt; 0;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    }</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160; </div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <a class="code" href="class_run_config.html">RunConfig</a> GetRunConfigForPackage(ContentPackage package)</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    {</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_cs_package_manager.html#aa915a7fe9a2418104e56d2087302f899">GetOrCreateRunConfig</a>(package, out var config))</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            config.<a class="code" href="class_run_config.html#a416484085c3efd4cb3741c1ae6cd9ffa">AutoGenerated</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        <span class="keywordflow">return</span> config;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    }</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    </div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="keyword">private</span> IEnumerable&lt;ContentPackage&gt; BuildPackagesList()</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    {</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;        <span class="comment">// get unique list of content packages. </span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        <span class="comment">// Note: there is an old issue where the AllPackages group</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <span class="comment">// would sometimes not contain packages downloaded from the host, so we union enabled.</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="keywordflow">return</span> ContentPackageManager.AllPackages.Union(ContentPackageManager.EnabledPackages.All).Where(pack =&gt; !pack.Name.ToLowerInvariant().Equals(<span class="stringliteral">&quot;vanilla&quot;</span>));</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    }</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160; </div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160; </div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> SyntaxTree GetPackageScriptImports() =&gt; BaseAssemblyImports;</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160; </div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    </div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> TryBuildDependenciesMap(ImmutableList&lt;ContentPackage&gt; packages, out Dictionary&lt;ContentPackage, List&lt;ContentPackage&gt;&gt; dependenciesMap)</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    {</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        <span class="keywordtype">bool</span> reliableMap = <span class="keyword">true</span>;    <span class="comment">// remains true if all deps were found.</span></div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        dependenciesMap = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        <span class="keywordflow">foreach</span> (var package <span class="keywordflow">in</span> packages)</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        {</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;            dependenciesMap.Add(package, <span class="keyword">new</span>());</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="class_cs_package_manager.html#aa915a7fe9a2418104e56d2087302f899">GetOrCreateRunConfig</a>(package, out var config))</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;            {</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                <span class="keywordflow">if</span> (config.Dependencies is <span class="keyword">null</span> || !config.Dependencies.Any())</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;            </div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                <span class="keywordflow">foreach</span> (<a class="code" href="class_run_config.html">RunConfig</a>.<a class="code" href="class_run_config_1_1_dependency.html">Dependency</a> dependency in config.Dependencies)</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                {</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                    ContentPackage dep = packages.FirstOrDefault(p =&gt; </div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                        (dependency.SteamWorkshopId != 0 &amp;&amp; p.TryExtractSteamWorkshopId(out var steamWorkshopId) </div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                                                         &amp;&amp; steamWorkshopId.Value == dependency.SteamWorkshopId) </div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                        || (!dependency.PackageName.IsNullOrWhiteSpace() &amp;&amp; p.Name.ToLowerInvariant().Contains(dependency.PackageName.ToLowerInvariant())), <span class="keyword">null</span>);</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160; </div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                    <span class="keywordflow">if</span> (dep is not <span class="keyword">null</span>)</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                    {</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                        dependenciesMap[package].Add(dep);</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                    }</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                    {</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                        ModUtils.Logging.PrintError($<span class="stringliteral">&quot;Warning! The ContentPackage {package.Name} lists a dependency of (STEAMID: {dependency.SteamWorkshopId}, PackageName: {dependency.PackageName}) but it could not be found in the to-be-loaded CSharp packages list!&quot;</span>);</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                        reliableMap = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                    }</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                }    </div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;            }</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;            {</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                ModUtils.Logging.PrintMessage($<span class="stringliteral">&quot;Warning! Could not retrieve RunConfig for ContentPackage {package.Name}!&quot;</span>);</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;            }</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        }</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        </div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        <span class="keywordflow">return</span> reliableMap;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    }</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    </div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> OrderAndFilterPackagesByDependencies(</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        Dictionary&lt;ContentPackage, ImmutableList&lt;ContentPackage&gt;&gt; packages,</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        out IEnumerable&lt;ContentPackage&gt; readyToLoad,</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        out IEnumerable&lt;KeyValuePair&lt;ContentPackage, string&gt;&gt; cannotLoadPackages,</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        Func&lt;ContentPackage, bool&gt; packageChecksPredicate = <span class="keyword">null</span>)</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    {</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        HashSet&lt;ContentPackage&gt; completedPackages = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        List&lt;ContentPackage&gt; readyPackages = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        Dictionary&lt;ContentPackage, string&gt; unableToLoad = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        HashSet&lt;ContentPackage&gt; currentNodeChain = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160; </div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        readyToLoad = readyPackages;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160; </div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="keywordflow">try</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        {</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            <span class="keywordflow">foreach</span> (var toProcessPack <span class="keywordflow">in</span> packages)</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            {</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                ProcessPackage(toProcessPack.Key, toProcessPack.Value);</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            }</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160; </div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;            PackageProcRet ProcessPackage(ContentPackage packageToProcess, IEnumerable&lt;ContentPackage&gt; dependencies)</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;            {</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                <span class="comment">//cyclic handling</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                <span class="keywordflow">if</span> (unableToLoad.ContainsKey(packageToProcess))</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                {</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                    <span class="keywordflow">return</span> PackageProcRet.BadPackage;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                }</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160; </div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                <span class="comment">// already processed</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                <span class="keywordflow">if</span> (completedPackages.Contains(packageToProcess))</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                {</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                    <span class="keywordflow">return</span> PackageProcRet.AlreadyCompleted;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                }</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                <span class="comment">// cyclic check</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                <span class="keywordflow">if</span> (currentNodeChain.Contains(packageToProcess))</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                {</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                    StringBuilder sb = <span class="keyword">new</span>();</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                    sb.AppendLine(<span class="stringliteral">&quot;Error: Cyclic Dependency. &quot;</span>)</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                        .Append(</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                            <span class="stringliteral">&quot;The following ContentPackages rely on eachother in a way that makes it impossible to know which to load first! &quot;</span>)</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                        .Append(</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                            <span class="stringliteral">&quot;Note: the package listed twice shows where the cycle starts/ends and is not necessarily the problematic package.&quot;</span>);</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                    <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                    <span class="keywordflow">foreach</span> (var package <span class="keywordflow">in</span> currentNodeChain)</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                    {</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                        i++;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                        sb.AppendLine($<span class="stringliteral">&quot;{i}. {package.Name}&quot;</span>);</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                    }</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160; </div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                    sb.AppendLine($<span class="stringliteral">&quot;{i}. {packageToProcess.Name}&quot;</span>);</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                    unableToLoad.Add(packageToProcess, sb.ToString());</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                    completedPackages.Add(packageToProcess);</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                    <span class="keywordflow">return</span> PackageProcRet.BadPackage;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                }</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160; </div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                <span class="keywordflow">if</span> (packageChecksPredicate is not <span class="keyword">null</span> &amp;&amp; !packageChecksPredicate.Invoke(packageToProcess))</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                    unableToLoad.Add(packageToProcess, $<span class="stringliteral">&quot;Unable to load package {packageToProcess.Name} due to failing checks.&quot;</span>);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                    completedPackages.Add(packageToProcess);</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                    <span class="keywordflow">return</span> PackageProcRet.BadPackage;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                }</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                currentNodeChain.Add(packageToProcess);</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160; </div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                <span class="keywordflow">foreach</span> (ContentPackage dependency <span class="keywordflow">in</span> dependencies)</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                {</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                    <span class="comment">// The mod lists a dependent that was not found during the discovery phase.</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                    <span class="keywordflow">if</span> (!packages.ContainsKey(dependency))</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                    {</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                        <span class="comment">// search to see if it&#39;s enabled</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                        <span class="keywordflow">if</span> (!ContentPackageManager.EnabledPackages.All.Contains(dependency))</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                        {</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                            <span class="comment">// present warning but allow loading anyways, better to let the user just disable the package if it&#39;s really an issue.</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                            ModUtils.Logging.PrintError(</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                                $<span class="stringliteral">&quot;Warning: the ContentPackage of {packageToProcess.Name} requires the Dependency {dependency.Name} but this package wasn&#39;t found in the enabled mods list!&quot;</span>);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                        }</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160; </div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                    }</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160; </div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                    var ret = ProcessPackage(dependency, packages[dependency]);</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160; </div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                    <span class="keywordflow">if</span> (ret is PackageProcRet.BadPackage)</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                    {</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                        <span class="keywordflow">if</span> (!unableToLoad.ContainsKey(packageToProcess))</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                        {</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                            unableToLoad.Add(packageToProcess, $<span class="stringliteral">&quot;Error: Dependency failure. Failed to load {dependency.Name}&quot;</span>);</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                        }</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                        currentNodeChain.Remove(packageToProcess);</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                        <span class="keywordflow">if</span> (!completedPackages.Contains(packageToProcess))</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                        {</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                            completedPackages.Add(packageToProcess);</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                        }</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                        <span class="keywordflow">return</span> PackageProcRet.BadPackage;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                    }</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                }</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                </div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                currentNodeChain.Remove(packageToProcess);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                completedPackages.Add(packageToProcess);</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                readyPackages.Add(packageToProcess); </div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                <span class="keywordflow">return</span> PackageProcRet.Completed;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            }</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        }</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        <span class="keywordflow">catch</span> (Exception e)</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        {</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;Error while generating dependency loading order! Exception: {e.Message}&quot;</span>);</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="preprocessor">#if DEBUG</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            ModUtils.Logging.PrintError($<span class="stringliteral">&quot;Stack Trace: {e.StackTrace}&quot;</span>);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            cannotLoadPackages = unableToLoad.Any() ? unableToLoad : <span class="keyword">null</span>;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        }</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        cannotLoadPackages = unableToLoad.Any() ? unableToLoad : <span class="keyword">null</span>;</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    }</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160; </div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    <span class="keyword">private</span> <span class="keyword">enum</span> PackageProcRet : <span class="keywordtype">byte</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    {</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        AlreadyCompleted,</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;        Completed,</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        BadPackage</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    }</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160; </div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <span class="keyword">private</span> record LoadableData(ImmutableList&lt;string&gt; AssembliesFilePaths, ImmutableList&lt;string&gt; ScriptsFilePaths);</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160; </div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="preprocessor">    #endregion</span></div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;}</div>
<div class="ttc" id="aclass_assembly_manager_html"><div class="ttname"><a href="class_assembly_manager.html">AssemblyManager</a></div><div class="ttdoc">Provides functionality for the loading, unloading and management of plugins implementing IAssemblyPlu...</div><div class="ttdef"><b>Definition:</b> <a href="_assembly_manager_8cs_source.html#l00028">AssemblyManager.cs:29</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html"><div class="ttname"><a href="class_cs_package_manager.html">CsPackageManager</a></div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00017">CsPackageManager.cs:18</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a0bb7fd36c673c19ad7205887af7018fd"><div class="ttname"><a href="class_cs_package_manager.html#a0bb7fd36c673c19ad7205887af7018fd">CsPackageManager.RunPluginsInit</a></div><div class="ttdeci">void RunPluginsInit()</div><div class="ttdoc">Executes instantiated plugins' Initialize() and OnLoadCompleted() methods.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00636">CsPackageManager.cs:636</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a1f77c8157a1f2c2d7c3f22cca629743b"><div class="ttname"><a href="class_cs_package_manager.html#a1f77c8157a1f2c2d7c3f22cca629743b">CsPackageManager.RunPluginsPreInit</a></div><div class="ttdeci">void RunPluginsPreInit()</div><div class="ttdoc">Executes instantiated plugins' PreInitPatching() method.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00677">CsPackageManager.cs:677</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a20c78091fe9d8c5ec0c6391f14376637"><div class="ttname"><a href="class_cs_package_manager.html#a20c78091fe9d8c5ec0c6391f14376637">CsPackageManager.TryGetLoadedPluginsForPackage</a></div><div class="ttdeci">bool TryGetLoadedPluginsForPackage(ContentPackage package, out IEnumerable&lt; IAssemblyPlugin &gt; loadedPlugins)</div><div class="ttdoc">Tries to get the loaded plugins for a given package.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00188">CsPackageManager.cs:188</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a35b59adf5dfbd582c00a390749d5be0d"><div class="ttname"><a href="class_cs_package_manager.html#a35b59adf5dfbd582c00a390749d5be0d">CsPackageManager.OnDispose</a></div><div class="ttdeci">Action OnDispose</div><div class="ttdoc">Called when clean up is being performed. Use when relying on or making use of references from this ma...</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00203">CsPackageManager.cs:203</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a44c3b8295b793470cb43f41bfac81689"><div class="ttname"><a href="class_cs_package_manager.html#a44c3b8295b793470cb43f41bfac81689">CsPackageManager.Dispose</a></div><div class="ttdeci">void Dispose()</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00205">CsPackageManager.cs:205</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a951b0de9b42f7a99609947b0491bcdf4"><div class="ttname"><a href="class_cs_package_manager.html#a951b0de9b42f7a99609947b0491bcdf4">CsPackageManager.AssembliesLoaded</a></div><div class="ttdeci">bool AssembliesLoaded</div><div class="ttdoc">Whether or not assemblies have been loaded.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00139">CsPackageManager.cs:139</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a97ebeeb2b13eb0c63ec0d57a818d03e2"><div class="ttname"><a href="class_cs_package_manager.html#a97ebeeb2b13eb0c63ec0d57a818d03e2">CsPackageManager.UnloadPlugins</a></div><div class="ttdeci">void UnloadPlugins()</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00769">CsPackageManager.cs:769</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_a99f48798f41081db900d2433158a003d"><div class="ttname"><a href="class_cs_package_manager.html#a99f48798f41081db900d2433158a003d">CsPackageManager.InstantiatePlugins</a></div><div class="ttdeci">void InstantiatePlugins(bool force=false)</div><div class="ttdoc">Initializes plugin types that are registered.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00712">CsPackageManager.cs:712</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_aa0761c436738450d43a3e529f68f4f9f"><div class="ttname"><a href="class_cs_package_manager.html#aa0761c436738450d43a3e529f68f4f9f">CsPackageManager.LoadAssemblyPackages</a></div><div class="ttdeci">AssemblyLoadingSuccessState LoadAssemblyPackages()</div><div class="ttdoc">Begins the loading process of scanning packages for scripts and binary assemblies,...</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00277">CsPackageManager.cs:277</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_aa696ddd3e1dd29288241085f01a62acc"><div class="ttname"><a href="class_cs_package_manager.html#aa696ddd3e1dd29288241085f01a62acc">CsPackageManager.TryGetPackageForPlugin&lt; T &gt;</a></div><div class="ttdeci">bool TryGetPackageForPlugin&lt; T &gt;(out ContentPackage package)</div><div class="ttdoc">Tries to find the content package that a given plugin belongs to.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00165">CsPackageManager.cs:165</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_aa915a7fe9a2418104e56d2087302f899"><div class="ttname"><a href="class_cs_package_manager.html#aa915a7fe9a2418104e56d2087302f899">CsPackageManager.GetOrCreateRunConfig</a></div><div class="ttdeci">static bool GetOrCreateRunConfig(ContentPackage package, out RunConfig config)</div><div class="ttdoc">Gets the RunConfig.xml for the given package located at [cp_root]/CSharp/RunConfig....</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00795">CsPackageManager.cs:795</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_ac68001aa5c72f709a3ff25ff85aa5f11"><div class="ttname"><a href="class_cs_package_manager.html#ac68001aa5c72f709a3ff25ff85aa5f11">CsPackageManager.PluginsPreInit</a></div><div class="ttdeci">bool PluginsPreInit</div><div class="ttdoc">Whether or not loaded plugins had their preloader run.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00145">CsPackageManager.cs:145</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_ac738a088519b2cdaa8c4565a0faeb687"><div class="ttname"><a href="class_cs_package_manager.html#ac738a088519b2cdaa8c4565a0faeb687">CsPackageManager.LuaTryRegisterPackageTypes</a></div><div class="ttdeci">bool LuaTryRegisterPackageTypes(string name, bool caseSensitive=false)</div><div class="ttdoc">Searches for all types in all loaded assemblies from content packages who's names contain the name st...</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00102">CsPackageManager.cs:102</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_accc4763a185ce2f5aafdad8be5592df1"><div class="ttname"><a href="class_cs_package_manager.html#accc4763a185ce2f5aafdad8be5592df1">CsPackageManager.PluginsInitialized</a></div><div class="ttdeci">bool PluginsInitialized</div><div class="ttdoc">Whether or not plugins' types have been instantiated.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00150">CsPackageManager.cs:150</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_ada5efea29c52e47b7de7ad220d9ca442"><div class="ttname"><a href="class_cs_package_manager.html#ada5efea29c52e47b7de7ad220d9ca442">CsPackageManager.PluginsLoaded</a></div><div class="ttdeci">bool PluginsLoaded</div><div class="ttdoc">Whether or not plugins are fully loaded.</div><div class="ttdef"><b>Definition:</b> <a href="_cs_package_manager_8cs_source.html#l00155">CsPackageManager.cs:155</a></div></div>
<div class="ttc" id="aclass_cs_package_manager_html_aec7c12a90515e14382a0dd65f5788761"><div class="ttname"><a href="class_cs_package_manager.html#aec7c12a90515e14382a0dd65f5788761">CsPackageManager.GetCurrentPackagesByLoadOrder</a></div><div class="ttdeci">IEnumerable&lt; ContentPackage &gt; GetCurrentPackagesByLoadOrder()</div></div>
<div class="ttc" id="aclass_run_config_1_1_dependency_html"><div class="ttname"><a href="class_run_config_1_1_dependency.html">RunConfig.Dependency</a></div><div class="ttdef"><b>Definition:</b> <a href="_run_config_8cs_source.html#l00042">RunConfig.cs:43</a></div></div>
<div class="ttc" id="aclass_run_config_html"><div class="ttname"><a href="class_run_config.html">RunConfig</a></div><div class="ttdef"><b>Definition:</b> <a href="_run_config_8cs_source.html#l00007">RunConfig.cs:8</a></div></div>
<div class="ttc" id="aclass_run_config_html_a416484085c3efd4cb3741c1ae6cd9ffa"><div class="ttname"><a href="class_run_config.html#a416484085c3efd4cb3741c1ae6cd9ffa">RunConfig.AutoGenerated</a></div><div class="ttdeci">bool AutoGenerated</div><div class="ttdef"><b>Definition:</b> <a href="_run_config_8cs_source.html#l00028">RunConfig.cs:28</a></div></div>
<div class="ttc" id="aclass_run_config_html_a7d843dcb3c7191dfdfb4f6ba63bc8ccb"><div class="ttname"><a href="class_run_config.html#a7d843dcb3c7191dfdfb4f6ba63bc8ccb">RunConfig.Sanitize</a></div><div class="ttdeci">RunConfig Sanitize()</div><div class="ttdef"><b>Definition:</b> <a href="_run_config_8cs_source.html#l00057">RunConfig.cs:57</a></div></div>
<div class="ttc" id="aclass_run_config_html_ab4e1322504d43e9a13af4a86208626cc"><div class="ttname"><a href="class_run_config.html#ab4e1322504d43e9a13af4a86208626cc">RunConfig.IsForced</a></div><div class="ttdeci">bool IsForced()</div><div class="ttdef"><b>Definition:</b> <a href="_run_config_8cs_source.html#l00091">RunConfig.cs:91</a></div></div>
<div class="ttc" id="aclass_run_config_html_ac17a7cd03af7ba9ab0d510464ffd154f"><div class="ttname"><a href="class_run_config.html#ac17a7cd03af7ba9ab0d510464ffd154f">RunConfig.IsForcedOrStandard</a></div><div class="ttdeci">bool IsForcedOrStandard()</div></div>
<div class="ttc" id="ainterface_i_assembly_plugin_html"><div class="ttname"><a href="interface_i_assembly_plugin.html">IAssemblyPlugin</a></div><div class="ttdef"><b>Definition:</b> <a href="_i_assembly_plugin_8cs_source.html#l00005">IAssemblyPlugin.cs:6</a></div></div>
<div class="ttc" id="anamespace_barotrauma_1_1_steam_html"><div class="ttname"><a href="namespace_barotrauma_1_1_steam.html">Barotrauma.Steam</a></div><div class="ttdef"><b>Definition:</b> <a href="_barotrauma_shared_2_shared_source_2_steam_2_auth_ticket_8cs_source.html#l00006">BarotraumaShared/SharedSource/Steam/AuthTicket.cs:7</a></div></div>
<div class="ttc" id="anamespace_barotrauma_html"><div class="ttname"><a href="namespace_barotrauma.html">Barotrauma</a></div><div class="ttdef"><b>Definition:</b> <a href="_cached_distance_8cs_source.html#l00003">CachedDistance.cs:4</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_8575ad821fc3b469d94fde51c8787ee3.html">Barotrauma</a></li><li class="navelem"><a class="el" href="dir_8b99819d2ee30d5e48f0b0f8b94f385a.html">BarotraumaShared</a></li><li class="navelem"><a class="el" href="dir_37517cc6f95be7cb877361d257ae4695.html">SharedSource</a></li><li class="navelem"><a class="el" href="dir_739e6e7eb2f3c8fe945bcf7ba994d357.html">LuaCs</a></li><li class="navelem"><a class="el" href="dir_d1a3d0e77444b04eede987753defd8d8.html">Plugins</a></li><li class="navelem"><b>CsPackageManager.cs</b></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
